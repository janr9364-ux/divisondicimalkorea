<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixed Decimal Division Exercises</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f4f8;
            margin: 0;
            color: #2c3e50;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            text-align: center;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 600px;
        }

        .hidden {
            display: none !important;
        }

        .initial-hidden {
            display: none;
        }

        h1 {
            color: #34495e;
            font-size: 2.5em;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .player-select {
            margin-bottom: 20px;
        }

        .player-select h2 {
            margin-bottom: 15px;
            color: #34495e;
            font-size: 1.5em;
        }

        button {
            padding: 12px 25px;
            margin: 0 10px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            background-color: #3498db;
            color: #fff;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 4px #2980b9;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(2px);
            box-shadow: 0 2px #2980b9;
        }

        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 12px;
        }

        .header h2 {
            margin: 5px 10px;
            font-size: 1.3em;
            font-weight: 600;
        }

        #score-board {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .score-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            font-weight: 500;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 2px solid #bdc3c7;
        }

        #timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
            min-width: 60px;
            text-align: right;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 20px auto;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1 / 1;
        }

        .cell {
            border: 3px solid #bdc3c7;
            background-color: #ecf0f1;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 10px;
        }

        .cell:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .question-area {
            margin-top: 20px;
        }

        #question {
            font-size: 1.8em;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 15px;
            min-height: 2em;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .exercise-type {
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: normal;
            margin-left: 10px;
        }

        #answer-input {
            padding: 10px 15px;
            font-size: 1.5em;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            text-align: center;
            width: 200px;
            transition: border-color 0.3s;
        }

        #answer-input:focus {
            outline: none;
            border-color: #3498db;
        }

        #submit-btn {
            margin-top: 15px;
        }

        #result-message {
            margin-top: 15px;
            font-weight: 600;
            font-size: 1.2em;
        }


        .name-input-container {
            margin-top: 20px;
        }

        .name-input-container .player-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .name-input-container .player-input-row input[type="text"] {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #bdc3c7;
            font-size: 1em;
            flex-grow: 1;
        }

        .color-options {
            display: flex;
            gap: 5px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 5px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
        }

        .color-option.selected {
            border-color: #3498db;
            transform: scale(1.1);
        }

        .back-btn {
            margin-top: 20px;
            background-color: #95a5a6;
            box-shadow: 0 4px #7f8c8d;
        }

        .back-btn:hover {
            background-color: #7f8c8d;
            box-shadow: 0 2px #7f8c8d;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px 10px rgba(52, 152, 219, 0.3);
            }
        }

        @keyframes pulse-available {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
                border-color: #bdc3c7;
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 15px 5px rgba(46, 204, 113, 0.5);
                border-color: #2ecc71;
            }
        }

        @keyframes pulse-player-color {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
                border-width: 3px;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
                border-color: var(--player-color);
                box-shadow: 0 0 15px 5px var(--player-color);
                border-width: 4px;
            }
        }

        @keyframes pulse-capturable {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.03);
                opacity: 0.9;
                box-shadow: inset 0 0 10px 2px var(--player-color);
            }
        }

        .practice-mode {
            max-width: 90%;
            width: 800px;
        }

        .problems-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .problem {
            border: 1px solid #ddd;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            position: relative;
        }

        .problem-number {
            font-weight: bold;
            margin-bottom: 10px;
            color: #666;
        }

        .division {
            font-size: 18px;
            text-align: center;
            margin: 10px 0;
        }

        .answer {
            color: #007bff;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
            font-size: 18px;
        }

        .show-answers {
            display: none;
        }

        .exercise-label {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
            background: #3498db;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="start-screen">
            <h1>소수 나눗셈 종합 게임</h1>
            <p>Mixed Decimal Division Exercises (A: 40%, B: 30%, C: 30%)</p>

            <div class="player-select">
                <h2>모드를 선택하세요</h2>
                <button onclick="showPracticeMode()">연습 모드</button>
                <button onclick="showDifficultySelect()">게임 모드</button>
            </div>
        </div>

        <div id="practice-mode" class="hidden practice-mode">
            <h1>연습 모드 - 소수 나눗셈 종합</h1>
            <button onclick="toggleAnswers()">Show/Hide Answers</button>
            <button class="back-btn" onclick="location.reload()">처음으로</button>

            <div class="problems-grid">
                <!-- Exercise A (40% - 8 problems) -->
                <div class="problem">
                    <div class="exercise-label">A</div>
                    <div class="problem-number">1)</div>
                    <div class="division">15.6 ÷ 2.4</div>
                    <div class="answer show-answers">= 6.5</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">A</div>
                    <div class="problem-number">2)</div>
                    <div class="division">21.6 ÷ 3.6</div>
                    <div class="answer show-answers">= 6</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">A</div>
                    <div class="problem-number">3)</div>
                    <div class="division">28.8 ÷ 4.8</div>
                    <div class="answer show-answers">= 6</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">A</div>
                    <div class="problem-number">4)</div>
                    <div class="division">18.2 ÷ 2.6</div>
                    <div class="answer show-answers">= 7</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">A</div>
                    <div class="problem-number">5)</div>
                    <div class="division">31.5 ÷ 4.5</div>
                    <div class="answer show-answers">= 7</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">A</div>
                    <div class="problem-number">6)</div>
                    <div class="division">25.2 ÷ 4.2</div>
                    <div class="answer show-answers">= 6</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">A</div>
                    <div class="problem-number">7)</div>
                    <div class="division">19.8 ÷ 3.3</div>
                    <div class="answer show-answers">= 6</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">A</div>
                    <div class="problem-number">8)</div>
                    <div class="division">35.2 ÷ 4.4</div>
                    <div class="answer show-answers">= 8</div>
                </div>

                <!-- Exercise B (30% - 6 problems) -->
                <div class="problem">
                    <div class="exercise-label">B</div>
                    <div class="problem-number">9)</div>
                    <div class="division">39.48 ÷ 5.64</div>
                    <div class="answer show-answers">= 7</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">B</div>
                    <div class="problem-number">10)</div>
                    <div class="division">26.88 ÷ 1.92</div>
                    <div class="answer show-answers">= 14</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">B</div>
                    <div class="problem-number">11)</div>
                    <div class="division">18.56 ÷ 2.52</div>
                    <div class="answer show-answers">= 7.37</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">B</div>
                    <div class="problem-number">12)</div>
                    <div class="division">21.06 ÷ 1.35</div>
                    <div class="answer show-answers">= 15.6</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">B</div>
                    <div class="problem-number">13)</div>
                    <div class="division">18.64 ÷ 1.44</div>
                    <div class="answer show-answers">= 12.94</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">B</div>
                    <div class="problem-number">14)</div>
                    <div class="division">21.45 ÷ 3.25</div>
                    <div class="answer show-answers">= 6.6</div>
                </div>

                <!-- Exercise C (30% - 6 problems) -->
                <div class="problem">
                    <div class="exercise-label">C</div>
                    <div class="problem-number">15)</div>
                    <div class="division">540 ÷ 6.75</div>
                    <div class="answer show-answers">= 80</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">C</div>
                    <div class="problem-number">16)</div>
                    <div class="division">46 ÷ 9.2</div>
                    <div class="answer show-answers">= 5</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">C</div>
                    <div class="problem-number">17)</div>
                    <div class="division">95 ÷ 3.8</div>
                    <div class="answer show-answers">= 25</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">C</div>
                    <div class="problem-number">18)</div>
                    <div class="division">72 ÷ 1.8</div>
                    <div class="answer show-answers">= 40</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">C</div>
                    <div class="problem-number">19)</div>
                    <div class="division">156 ÷ 2.6</div>
                    <div class="answer show-answers">= 60</div>
                </div>

                <div class="problem">
                    <div class="exercise-label">C</div>
                    <div class="problem-number">20)</div>
                    <div class="division">135 ÷ 4.5</div>
                    <div class="answer show-answers">= 30</div>
                </div>
            </div>
        </div>

        <div id="difficulty-select" class="player-select hidden">
            <h2>난이도를 선택하세요</h2>
            <button onclick="selectDifficulty('easy')">쉬움 (80초) ⭐</button>
            <button onclick="selectDifficulty('medium')">보통 (60초) ⭐⭐</button>
            <button onclick="selectDifficulty('hard')">어려움 (30초) ⭐⭐⭐</button>
            <button class="back-btn" onclick="location.reload()">처음으로</button>
        </div>

        <div id="player-count-select" class="player-select hidden">
            <h2>함께할 친구들의 수를 선택하세요</h2>
            <button onclick="startGame(1)">1인용 (컴퓨터와 대결)</button>
            <button onclick="showNameInputs(2)">2명</button>
            <button onclick="showNameInputs(3)">3명</button>
            <button onclick="showNameInputs(4)">4명</button>
            <button class="back-btn" onclick="location.reload()">처음으로</button>
        </div>

        <div id="name-input-container" class="hidden name-input-container">
            <h2>친구들의 이름과 색깔을 입력하세요</h2>
            <div id="name-inputs"></div>
            <button onclick="startPlaying()">게임 시작</button>
            <button class="back-btn" onclick="location.reload()">처음으로</button>
            <div id="color-error-message" style="color: #e74c3c; margin-top: 10px;"></div>
        </div>

        <div id="game-container" class="hidden">
            <div class="header">
                <h2 id="player-turn"></h2>
                <div id="timer">30초</div>
                <div id="score-board"></div>
            </div>

            <div class="game-board" id="game-board">
            </div>

            <div class="question-area initial-hidden">
                <div id="question"></div>
                <input type="number" id="answer-input" placeholder="답" step="0.01">
                <br>
                <button id="submit-btn">정답 확인</button>
                <div id="result-message"></div>
            </div>

            <button id="restart-btn" class="hidden">게임 재시작</button>
            <button id="back-to-start-btn" class="back-btn">처음으로</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startScreen = document.getElementById('start-screen');
            const practiceMode = document.getElementById('practice-mode');
            const playerCountSelect = document.getElementById('player-count-select');
            const nameInputContainer = document.getElementById('name-input-container');
            const nameInputsEl = document.getElementById('name-inputs');
            const colorErrorMessageEl = document.getElementById('color-error-message');
            const gameContainer = document.getElementById('game-container');
            const gameBoard = document.getElementById('game-board');
            const questionArea = document.querySelector('.question-area');
            const questionEl = document.getElementById('question');
            const answerInput = document.getElementById('answer-input');
            const submitBtn = document.getElementById('submit-btn');
            const resultMessageEl = document.getElementById('result-message');
            const playerTurnEl = document.getElementById('player-turn');
            const scoreBoardEl = document.getElementById('score-board');
            const restartBtn = document.getElementById('restart-btn');
            const backToStartBtn = document.getElementById('back-to-start-btn');
            const timerEl = document.getElementById('timer');

            let totalPlayers = 0;
            let players = [];
            let currentPlayer = 1;
            let scores = {};
            let boardState = Array(25).fill(0);
            let activeCellIndex = null;
            let correctAnswer = '';
            let isFirstTry = true;
            let isSinglePlayer = false;
            let isComputerThinking = false;

            const colorPalette = ['#e74c3c', '#2ecc71', '#3498db', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];

            let timerInterval;
            let timeLeft = 30;
            let difficultyLevel = 'medium'; // 'easy', 'medium', 'hard'

            window.toggleAnswers = () => {
                const answers = document.querySelectorAll('.answer');
                answers.forEach(answer => {
                    answer.classList.toggle('show-answers');
                });
            };

            window.showPracticeMode = () => {
                startScreen.classList.add('hidden');
                practiceMode.classList.remove('hidden');
            };

            window.showDifficultySelect = () => {
                startScreen.classList.add('hidden');
                document.getElementById('difficulty-select').classList.remove('hidden');
            };

            window.selectDifficulty = (level) => {
                difficultyLevel = level;
                document.getElementById('difficulty-select').classList.add('hidden');
                playerCountSelect.classList.remove('hidden');
            };

            window.showPlayerSelect = () => {
                startScreen.classList.add('hidden');
                playerCountSelect.classList.remove('hidden');
            };

            window.startGame = (numPlayers) => {
                isSinglePlayer = (numPlayers === 1);

                if (isSinglePlayer) {
                    totalPlayers = 2;
                    players = [{ name: "나", color: colorPalette[0] }, { name: "컴퓨터", color: colorPalette[1] }];
                    playerCountSelect.classList.add('hidden');
                    gameContainer.classList.remove('hidden');
                    initializeGame();
                } else {
                    totalPlayers = numPlayers;
                    showNameInputs(numPlayers);
                }
            };

            window.showNameInputs = (numPlayers) => {
                totalPlayers = numPlayers;
                playerCountSelect.classList.add('hidden');
                nameInputContainer.classList.remove('hidden');
                nameInputsEl.innerHTML = '';
                colorErrorMessageEl.innerText = '';

                for (let i = 0; i < totalPlayers; i++) {
                    const row = document.createElement('div');
                    row.classList.add('player-input-row');

                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.placeholder = `플레이어 ${i + 1} 이름`;
                    nameInput.value = `플레이어 ${i + 1}`;

                    const colorOptions = document.createElement('div');
                    colorOptions.classList.add('color-options');

                    colorPalette.forEach((color, colorIndex) => {
                        const option = document.createElement('div');
                        option.classList.add('color-option');
                        option.style.backgroundColor = color;
                        option.dataset.color = color;

                        if (colorIndex === i) {
                            option.classList.add('selected');
                        }

                        option.addEventListener('click', () => {
                            row.querySelectorAll('.color-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                            option.classList.add('selected');
                            colorErrorMessageEl.innerText = '';
                        });
                        colorOptions.appendChild(option);
                    });

                    row.appendChild(nameInput);
                    row.appendChild(colorOptions);
                    nameInputsEl.appendChild(row);
                }
            };

            window.startPlaying = () => {
                const inputRows = nameInputsEl.querySelectorAll('.player-input-row');
                const selectedColors = new Set();
                let isColorDuplicate = false;

                players = Array.from(inputRows).map((row, index) => {
                    const name = row.querySelector('input[type="text"]').value.trim() || `플레이어 ${index + 1}`;
                    const selectedOption = row.querySelector('.color-option.selected');
                    const color = selectedOption ? selectedOption.dataset.color : colorPalette[index];

                    if (selectedColors.has(color)) {
                        isColorDuplicate = true;
                        colorErrorMessageEl.innerText = "서로 다른 색깔을 선택해야 합니다. 다시 선택해주세요.";
                    }
                    selectedColors.add(color);

                    return { name, color };
                });

                if (isColorDuplicate) {
                    return;
                }

                nameInputContainer.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                initializeGame();
            };

            function initializeGame() {
                currentPlayer = 1;
                scores = {};
                players.forEach((player, index) => {
                    scores[index + 1] = 0;
                });
                boardState = Array(25).fill(0);
                activeCellIndex = null;
                isFirstTry = true;

                createBoard();
                updateScores();
                updatePlayerTurn();

                questionArea.classList.add('initial-hidden');
                questionEl.innerHTML = '게임을 시작하려면 칸을 선택하세요!';
                answerInput.value = '';
                resultMessageEl.innerText = '';
                restartBtn.classList.add('hidden');
                submitBtn.disabled = false;
                // Update timer display based on difficulty
                if (difficultyLevel === 'easy') {
                    timerEl.innerText = '';
                } else if (difficultyLevel === 'medium') {
                    timerEl.innerText = '';
                } else {
                    timerEl.innerText = '';
                }
            }

            function createBoard() {
                gameBoard.innerHTML = '';
                for (let i = 0; i < 25; i++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.index = i;
                    cell.addEventListener('click', () => handleCellClick(i));
                    gameBoard.appendChild(cell);
                }
            }

            function updatePlayerTurn() {
                const player = players[currentPlayer - 1];
                playerTurnEl.innerHTML = `
                    현재 턴: 
                    <span style="color:${player.color};">${player.name}</span>
                `;

                if (!isSinglePlayer || currentPlayer === 1) {
                    if (activeCellIndex === null && !isComputerThinking) {
                        showAvailableTiles();
                    }
                }
            }

            function showAvailableTiles() {
                const isFirstMove = scores[currentPlayer] === 0;
                const player = players[currentPlayer - 1];

                for (let i = 0; i < gameBoard.children.length; i++) {
                    gameBoard.children[i].style.animation = '';
                    gameBoard.children[i].style.setProperty('--player-color', 'transparent');
                }

                if (isFirstMove) {
                    resultMessageEl.innerText = "🎯 첫 번째 칸을 선택하세요! 아무 빈 칸이나 선택할 수 있습니다.";
                    resultMessageEl.style.color = player.color;

                    for (let i = 0; i < boardState.length; i++) {
                        if (boardState[i] === 0) {
                            const cell = gameBoard.children[i];
                            cell.style.setProperty('--player-color', player.color);
                            cell.style.animation = 'pulse-player-color 2.5s ease-in-out infinite';
                        }
                    }
                } else {
                    const selectableEmptyCells = [];
                    const capturableCells = [];

                    for (let i = 0; i < boardState.length; i++) {
                        if (boardState[i] === currentPlayer) {
                            const row = Math.floor(i / 5);
                            const col = i % 5;
                            const adjacentIndices = [];

                            if (row > 0) adjacentIndices.push(i - 5);
                            if (row < 4) adjacentIndices.push(i + 5);
                            if (col > 0) adjacentIndices.push(i - 1);
                            if (col < 4) adjacentIndices.push(i + 1);

                            adjacentIndices.forEach(adjIndex => {
                                if (boardState[adjIndex] === 0 && !selectableEmptyCells.includes(adjIndex)) {
                                    selectableEmptyCells.push(adjIndex);
                                } else if (boardState[adjIndex] !== 0 && boardState[adjIndex] !== currentPlayer && !capturableCells.includes(adjIndex)) {
                                    capturableCells.push(adjIndex);
                                }
                            });
                        }
                    }

                    const totalSelectable = selectableEmptyCells.length + capturableCells.length;

                    if (totalSelectable > 0) {
                        if (capturableCells.length > 0) {
                            resultMessageEl.innerText = "🎯 반짝이는 칸을 선택하세요! (빈 칸 또는 상대방 칸 빼앗기 가능)";
                        } else {
                            resultMessageEl.innerText = "🎯 반짝이는 칸 중 하나를 선택하세요! (자신의 땅과 인접한 칸)";
                        }
                        resultMessageEl.style.color = player.color;

                        selectableEmptyCells.forEach(cellIndex => {
                            const cell = gameBoard.children[cellIndex];
                            cell.style.setProperty('--player-color', player.color);
                            cell.style.animation = 'pulse-player-color 2.5s ease-in-out infinite';
                        });

                        capturableCells.forEach(cellIndex => {
                            const cell = gameBoard.children[cellIndex];
                            cell.style.setProperty('--player-color', player.color);
                            cell.style.animation = 'pulse-capturable 2.5s ease-in-out infinite';
                        });
                    } else {
                        resultMessageEl.innerText = "선택 가능한 칸이 없습니다!";
                        resultMessageEl.style.color = '#e74c3c';
                    }
                }
            }

            function updateScores() {
                scoreBoardEl.innerHTML = '';
                players.forEach((player, index) => {
                    const scoreItem = document.createElement('div');
                    scoreItem.classList.add('score-item');
                    scoreItem.innerHTML = `
                        <div class="color-swatch" style="background-color: ${player.color};"></div>
                        <span>${player.name}: ${scores[index + 1]}</span>
                    `;
                    scoreBoardEl.appendChild(scoreItem);
                });
            }

            function startTimer() {
                // Set time based on difficulty level
                if (difficultyLevel === 'easy') {
                    timeLeft = 80;
                } else if (difficultyLevel === 'medium') {
                    timeLeft = 60;
                } else { // hard
                    timeLeft = 30;
                }

                timerEl.innerText = `${timeLeft}초`;
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.innerText = `${timeLeft}초`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        handleTimeout();
                    }
                }, 1000);
            }

            function handleTimeout() {
                if (activeCellIndex !== null) {
                    resultMessageEl.innerText = "시간 초과! 😢 다음 턴으로 넘어갑니다.";
                    resultMessageEl.style.color = '#c0392b';
                    questionArea.classList.add('initial-hidden');
                    activeCellIndex = null;
                    isFirstTry = true;
                    switchTurn();
                }
            }

            function isAdjacentToPlayerCells(index, player) {
                const row = Math.floor(index / 5);
                const col = index % 5;
                const neighbors = [];

                if (row > 0) neighbors.push(index - 5);
                if (row < 4) neighbors.push(index + 5);
                if (col > 0) neighbors.push(index - 1);
                if (col < 4) neighbors.push(index + 1);

                for (const neighborIndex of neighbors) {
                    if (boardState[neighborIndex] === player) {
                        return true;
                    }
                }
                return false;
            }

            function handleCellClick(index) {
                if (activeCellIndex !== null) {
                    return;
                }

                if (isSinglePlayer && isComputerThinking) {
                    resultMessageEl.innerText = "컴퓨터의 턴입니다.";
                    return;
                }

                const isFirstMove = scores[currentPlayer] === 0;
                const isSelectable = isFirstMove || isAdjacentToPlayerCells(index, currentPlayer);

                if (isSelectable) {
                    if (boardState[index] === currentPlayer) {
                        resultMessageEl.innerText = "이미 당신의 땅입니다.";
                        return;
                    }

                    for (let i = 0; i < gameBoard.children.length; i++) {
                        gameBoard.children[i].style.animation = '';
                        gameBoard.children[i].style.setProperty('--player-color', 'transparent');
                    }

                    activeCellIndex = index;
                    questionArea.classList.remove('initial-hidden');
                    generateMixedQuestion();
                    answerInput.value = '';
                    resultMessageEl.innerText = '정답을 입력하세요!';
                    answerInput.focus();
                    startTimer();
                } else {
                    const player = players[currentPlayer - 1];
                    resultMessageEl.innerText = "⚠️ 반짝이는 칸만 선택할 수 있습니다! (자신의 땅과 인접한 칸)";
                    resultMessageEl.style.color = '#e74c3c';
                    showAvailableTiles();
                }
            }

            function generateMixedQuestion() {
                // Generate random exercise type based on proportions: A(40%), B(30%), C(30%)
                const rand = Math.random();

                if (rand < 0.4) {
                    generateExerciseA();
                } else if (rand < 0.7) {
                    generateExerciseB();
                } else {
                    generateExerciseC();
                }
            }

            function generateExerciseA() {
                // Exercise A: One decimal place ÷ One decimal place
                // Pre-calculated exact problems only
                const exactProblems = [
                    // --- 50 whole-number answers ---
                    { dividend: 2.2, divisor: 1.1, answer: 2 },
                    { dividend: 3.6, divisor: 1.2, answer: 3 },
                    { dividend: 5.2, divisor: 1.3, answer: 4 },
                    { dividend: 7.0, divisor: 1.4, answer: 5 },
                    { dividend: 9.0, divisor: 1.5, answer: 6 },
                    { dividend: 11.2, divisor: 1.6, answer: 7 },
                    { dividend: 13.6, divisor: 1.7, answer: 8 },
                    { dividend: 16.2, divisor: 1.8, answer: 9 },
                    { dividend: 19.0, divisor: 1.9, answer: 10 },
                    { dividend: 22.0, divisor: 2.0, answer: 11 },
                    { dividend: 25.2, divisor: 2.1, answer: 12 },
                    { dividend: 28.6, divisor: 2.2, answer: 13 },
                    { dividend: 32.2, divisor: 2.3, answer: 14 },
                    { dividend: 36.0, divisor: 2.4, answer: 15 },
                    { dividend: 40.0, divisor: 2.5, answer: 16 },
                    { dividend: 44.2, divisor: 2.6, answer: 17 },
                    { dividend: 48.6, divisor: 2.7, answer: 18 },
                    { dividend: 53.2, divisor: 2.8, answer: 19 },
                    { dividend: 58.0, divisor: 2.9, answer: 20 },
                    { dividend: 63.0, divisor: 3.0, answer: 21 },
                    { dividend: 68.2, divisor: 3.1, answer: 22 },
                    { dividend: 73.6, divisor: 3.2, answer: 23 },
                    { dividend: 79.2, divisor: 3.3, answer: 24 },
                    { dividend: 85.0, divisor: 3.4, answer: 25 },
                    { dividend: 91.0, divisor: 3.5, answer: 26 },
                    { dividend: 49.2, divisor: 4.1, answer: 12 },
                    { dividend: 58.8, divisor: 4.2, answer: 14 },
                    { dividend: 47.3, divisor: 4.3, answer: 11 },
                    { dividend: 57.2, divisor: 4.4, answer: 13 },
                    { dividend: 40.5, divisor: 4.5, answer: 9 },
                    { dividend: 69.0, divisor: 4.6, answer: 15 },
                    { dividend: 37.6, divisor: 4.7, answer: 8 },
                    { dividend: 76.8, divisor: 4.8, answer: 16 },
                    { dividend: 34.3, divisor: 4.9, answer: 7 },
                    { dividend: 95.0, divisor: 5.0, answer: 19 },
                    { dividend: 51.0, divisor: 5.1, answer: 10 },
                    { dividend: 62.4, divisor: 5.2, answer: 12 },
                    { dividend: 47.7, divisor: 5.3, answer: 9 },
                    { dividend: 75.6, divisor: 5.4, answer: 14 },
                    { dividend: 44.0, divisor: 5.5, answer: 8 },
                    { dividend: 61.6, divisor: 5.6, answer: 11 },
                    { dividend: 74.1, divisor: 5.7, answer: 13 },
                    { dividend: 40.6, divisor: 5.8, answer: 7 },
                    { dividend: 53.1, divisor: 5.9, answer: 9 },
                    { dividend: 72.0, divisor: 6.0, answer: 12 },
                    { dividend: 48.8, divisor: 6.1, answer: 8 },
                    { dividend: 55.8, divisor: 6.2, answer: 9 },
                    { dividend: 44.1, divisor: 6.3, answer: 7 },
                    { dividend: 76.8, divisor: 6.4, answer: 12 },

                    // --- 50 one-decimal answers ---
                    { dividend: 14.6, divisor: 2.0, answer: 7.3 },
                    { dividend: 18.2, divisor: 2.0, answer: 9.1 },
                    { dividend: 17.2, divisor: 2.0, answer: 8.6 },
                    { dividend: 15.8, divisor: 2.0, answer: 7.9 },
                    { dividend: 13.0, divisor: 2.0, answer: 6.5 },
                    { dividend: 9.0, divisor: 2.0, answer: 4.5 },
                    { dividend: 11.0, divisor: 2.0, answer: 5.5 },
                    { dividend: 7.4, divisor: 2.0, answer: 3.7 },
                    { dividend: 5.6, divisor: 2.0, answer: 2.8 },
                    { dividend: 3.8, divisor: 2.0, answer: 1.9 },
                    { dividend: 21.6, divisor: 3.0, answer: 7.2 },
                    { dividend: 22.8, divisor: 3.0, answer: 7.6 },
                    { dividend: 24.3, divisor: 3.0, answer: 8.1 },
                    { dividend: 25.5, divisor: 3.0, answer: 8.5 },
                    { dividend: 26.7, divisor: 3.0, answer: 8.9 },
                    { dividend: 27.6, divisor: 3.0, answer: 9.2 },
                    { dividend: 20.7, divisor: 3.0, answer: 6.9 },
                    { dividend: 22.5, divisor: 3.0, answer: 7.5 },
                    { dividend: 13.5, divisor: 3.0, answer: 4.5 },
                    { dividend: 28.5, divisor: 3.0, answer: 9.5 },
                    { dividend: 22.4, divisor: 3.5, answer: 6.4 },
                    { dividend: 20.3, divisor: 3.5, answer: 5.8 },
                    { dividend: 25.2, divisor: 3.5, answer: 7.2 },
                    { dividend: 30.1, divisor: 3.5, answer: 8.6 },
                    { dividend: 27.9, divisor: 4.5, answer: 6.2 },
                    { dividend: 21.6, divisor: 4.5, answer: 4.8 },
                    { dividend: 33.3, divisor: 4.5, answer: 7.4 },
                    { dividend: 39.6, divisor: 4.5, answer: 8.8 },
                    { dividend: 25.2, divisor: 4.5, answer: 5.6 },
                    { dividend: 34.1, divisor: 5.5, answer: 6.2 },
                    { dividend: 26.4, divisor: 5.5, answer: 4.8 },
                    { dividend: 40.7, divisor: 5.5, answer: 7.4 },
                    { dividend: 48.4, divisor: 5.5, answer: 8.8 },
                    { dividend: 28.6, divisor: 5.5, answer: 5.2 },
                    { dividend: 42.9, divisor: 6.5, answer: 6.6 },
                    { dividend: 31.2, divisor: 6.5, answer: 4.8 },
                    { dividend: 46.8, divisor: 6.5, answer: 7.2 },
                    { dividend: 57.2, divisor: 6.5, answer: 8.8 },
                    { dividend: 35.1, divisor: 6.5, answer: 5.4 },
                    { dividend: 18.0, divisor: 7.5, answer: 2.4 },
                    { dividend: 51.0, divisor: 7.5, answer: 6.8 },
                    { dividend: 61.5, divisor: 7.5, answer: 8.2 },
                    { dividend: 34.5, divisor: 7.5, answer: 4.6 },
                    { dividend: 70.5, divisor: 7.5, answer: 9.4 },
                    { dividend: 54.4, divisor: 8.5, answer: 6.4 },
                    { dividend: 35.7, divisor: 8.5, answer: 4.2 },
                    { dividend: 66.3, divisor: 8.5, answer: 7.8 },
                    { dividend: 23.8, divisor: 8.5, answer: 2.8 },
                    { dividend: 47.6, divisor: 8.5, answer: 5.6 },
                    { dividend: 16.5, divisor: 2.2, answer: 7.5 },
                    { dividend: 22.1, divisor: 3.4, answer: 6.5 },
                    { dividend: 29.9, divisor: 4.6, answer: 6.5 },
                    { dividend: 35.1, divisor: 5.4, answer: 6.5 },
                    { dividend: 41.6, divisor: 6.4, answer: 6.5 },
                ];
                const problem = exactProblems[Math.floor(Math.random() * exactProblems.length)];
                correctAnswer = problem.answer;
                questionEl.innerHTML = `${problem.dividend} ÷ ${problem.divisor} = ?`;
            }

            function generateExerciseB() {
                // Exercise B: Two decimal places ÷ Two decimal places
                // Pre-calculated exact problems only (all exact; no rounding)
                const exactProblems = [
                    // integer answers
                    { dividend: 5.70, divisor: 2.85, answer: 2 },
                    { dividend: 11.31, divisor: 3.77, answer: 3 },
                    { dividend: 6.92, divisor: 1.73, answer: 4 },
                    { dividend: 6.65, divisor: 1.33, answer: 5 },
                    { dividend: 7.56, divisor: 1.26, answer: 6 },
                    { dividend: 21.49, divisor: 3.07, answer: 7 },
                    { dividend: 19.44, divisor: 2.43, answer: 8 },
                    { dividend: 27.99, divisor: 3.11, answer: 9 },
                    { dividend: 12.60, divisor: 1.26, answer: 10 },
                    { dividend: 42.68, divisor: 3.88, answer: 11 },
                    { dividend: 46.08, divisor: 3.84, answer: 12 },
                    { dividend: 14.95, divisor: 1.15, answer: 13 },
                    { dividend: 17.36, divisor: 1.24, answer: 14 },
                    { dividend: 48.45, divisor: 3.23, answer: 15 },
                    { dividend: 41.44, divisor: 2.59, answer: 16 },
                    { dividend: 34.17, divisor: 2.01, answer: 17 },
                    { dividend: 36.72, divisor: 2.04, answer: 18 },
                    { dividend: 39.33, divisor: 2.07, answer: 19 },
                    { dividend: 78.00, divisor: 3.90, answer: 20 },
                    { dividend: 45.36, divisor: 2.16, answer: 21 },
                    { dividend: 74.36, divisor: 3.38, answer: 22 },
                    { dividend: 63.25, divisor: 2.75, answer: 23 },
                    { dividend: 69.84, divisor: 2.91, answer: 24 },
                    { dividend: 72.25, divisor: 2.89, answer: 25 },
                    { dividend: 40.82, divisor: 1.57, answer: 26 },
                    { dividend: 46.71, divisor: 1.73, answer: 27 },
                    { dividend: 48.72, divisor: 1.74, answer: 28 },
                    { dividend: 79.36, divisor: 2.48, answer: 32 }, // fixed
                    { dividend: 59.04, divisor: 1.64, answer: 36 },
                    { dividend: 87.02, divisor: 2.29, answer: 38 }, // fixed
                    { dividend: 71.44, divisor: 1.88, answer: 38 }, // fixed
                    { dividend: 67.20, divisor: 1.40, answer: 48 },
                    { dividend: 76.80, divisor: 1.60, answer: 48 },
                    { dividend: 87.04, divisor: 1.36, answer: 64 }, // fixed

                    // one-decimal answers
                    { dividend: 6.93, divisor: 9.90, answer: 0.7 },
                    { dividend: 7.92, divisor: 9.90, answer: 0.8 },
                    { dividend: 8.91, divisor: 9.90, answer: 0.9 },
                    { dividend: 10.56, divisor: 9.60, answer: 1.1 },
                    { dividend: 12.48, divisor: 9.60, answer: 1.3 },
                    { dividend: 14.40, divisor: 9.60, answer: 1.5 },
                    { dividend: 16.32, divisor: 9.60, answer: 1.7 },
                    { dividend: 18.24, divisor: 9.60, answer: 1.9 },
                    { dividend: 13.86, divisor: 7.70, answer: 1.8 },
                    { dividend: 16.17, divisor: 7.70, answer: 2.1 },
                    { dividend: 18.48, divisor: 7.70, answer: 2.4 },
                    { dividend: 20.79, divisor: 7.70, answer: 2.7 },
                    { dividend: 24.75, divisor: 7.50, answer: 3.3 }, // fixed
                    { dividend: 27.01, divisor: 7.30, answer: 3.7 }, // fixed
                    { dividend: 32.34, divisor: 7.35, answer: 4.4 }, // fixed
                    { dividend: 33.39, divisor: 7.42, answer: 4.5 },
                    { dividend: 38.61, divisor: 7.02, answer: 5.5 },
                    { dividend: 43.89, divisor: 6.65, answer: 6.6 }, // fixed
                    { dividend: 46.92, divisor: 6.80, answer: 6.9 }, // fixed
                    { dividend: 48.60, divisor: 6.75, answer: 7.2 }, // fixed
                    { dividend: 52.36, divisor: 6.80, answer: 7.7 }, // fixed
                    { dividend: 58.59, divisor: 6.30, answer: 9.3 },
                    { dividend: 61.88, divisor: 6.80, answer: 9.1 },
                    { dividend: 64.38, divisor: 7.40, answer: 8.7 }, // fixed
                    { dividend: 69.92, divisor: 7.60, answer: 9.2 }, // fixed
                    { dividend: 74.25, divisor: 7.50, answer: 9.9 }, // fixed
                    { dividend: 76.44, divisor: 7.80, answer: 9.8 }, // fixed
                    { dividend: 80.19, divisor: 8.10, answer: 9.9 }, // fixed
                    { dividend: 82.77, divisor: 8.90, answer: 9.3 }, // fixed
                    { dividend: 9.61, divisor: 3.10, answer: 3.1 },
                    { dividend: 36.04, divisor: 6.80, answer: 5.3 },
                    { dividend: 38.43, divisor: 6.30, answer: 6.1 },
                    { dividend: 61.92, divisor: 7.20, answer: 8.6 },

                    // two-decimal answers
                    { dividend: 36.36, divisor: 9.00, answer: 4.04 },
                    { dividend: 32.80, divisor: 8.00, answer: 4.10 },
                    { dividend: 1.59, divisor: 1.50, answer: 1.06 },
                    { dividend: 7.82, divisor: 5.75, answer: 1.36 },
                    { dividend: 12.41, divisor: 8.50, answer: 1.46 },
                    { dividend: 4.56, divisor: 2.40, answer: 1.90 },
                    { dividend: 18.48, divisor: 8.25, answer: 2.24 },
                    { dividend: 10.20, divisor: 3.75, answer: 2.72 },
                    { dividend: 23.49, divisor: 5.80, answer: 4.05 },
                    { dividend: 33.79, divisor: 7.75, answer: 4.36 },
                    { dividend: 12.05, divisor: 2.50, answer: 4.82 },
                    { dividend: 24.57, divisor: 4.50, answer: 5.46 },
                    { dividend: 12.96, divisor: 2.25, answer: 5.76 },
                    { dividend: 23.24, divisor: 4.00, answer: 5.81 },
                    { dividend: 25.76, divisor: 7.00, answer: 3.68 },
                    { dividend: 95.94, divisor: 6.00, answer: 15.99 },
                    { dividend: 81.40, divisor: 2.50, answer: 32.56 },
                    { dividend: 25.22, divisor: 6.50, answer: 3.88 },
                    { dividend: 27.14, divisor: 2.00, answer: 13.57 },
                    { dividend: 16.96, divisor: 4.00, answer: 4.24 },
                    { dividend: 62.79, divisor: 1.40, answer: 44.85 },
                    { dividend: 93.18, divisor: 1.50, answer: 62.12 },
                    { dividend: 91.47, divisor: 3.00, answer: 30.49 },
                    { dividend: 64.61, divisor: 1.75, answer: 36.92 },
                    { dividend: 88.01, divisor: 2.60, answer: 33.85 },
                    { dividend: 19.53, divisor: 1.50, answer: 13.02 }, // fixed
                    { dividend: 35.91, divisor: 2.10, answer: 17.10 },
                    { dividend: 62.94, divisor: 1.20, answer: 52.45 },
                    { dividend: 82.98, divisor: 1.50, answer: 55.32 },
                    { dividend: 52.06, divisor: 2.00, answer: 26.03 },
                    { dividend: 44.88, divisor: 3.00, answer: 14.96 },
                    { dividend: 53.82, divisor: 3.00, answer: 17.94 },
                    { dividend: 71.76, divisor: 3.00, answer: 23.92 },
                    { dividend: 86.13, divisor: 2.25, answer: 38.28 },
                    { dividend: 83.88, divisor: 4.00, answer: 20.97 },
                    { dividend: 40.48, divisor: 5.75, answer: 7.04 },
                    { dividend: 89.05, divisor: 2.50, answer: 35.62 },
                    { dividend: 67.87, divisor: 2.75, answer: 24.68 },
                    { dividend: 43.47, divisor: 4.60, answer: 9.45 },
                    { dividend: 58.23, divisor: 1.50, answer: 38.82 },
                    { dividend: 10.78, divisor: 7.00, answer: 1.54 },
                    { dividend: 74.62, divisor: 5.20, answer: 14.35 },
                    { dividend: 77.49, divisor: 1.64, answer: 47.25 },
                    { dividend: 75.39, divisor: 3.50, answer: 21.54 },
                    { dividend: 95.22, divisor: 6.00, answer: 15.87 },
                    { dividend: 10.48, divisor: 8.00, answer: 1.31 },
                    { dividend: 82.85, divisor: 5.00, answer: 16.57 },
                ];

                const problem = exactProblems[Math.floor(Math.random() * exactProblems.length)];
                correctAnswer = problem.answer;
                questionEl.innerHTML = `${problem.dividend} ÷ ${problem.divisor} = ?`;
            }

            function generateExerciseC() {
                // Exercise C: Whole number ÷ Decimal
                // Pre-calculated exact problems only (100 problems)
                const exactProblems = [
                    { dividend: 540, divisor: 6.75, answer: 80 },
                    { dividend: 46, divisor: 9.2, answer: 5 },
                    { dividend: 95, divisor: 3.8, answer: 25 },
                    { dividend: 72, divisor: 1.8, answer: 40 },
                    { dividend: 156, divisor: 2.6, answer: 60 },
                    { dividend: 135, divisor: 4.5, answer: 30 },
                    { dividend: 225, divisor: 7.5, answer: 30 },
                    { dividend: 120, divisor: 2.4, answer: 50 },
                    { dividend: 84, divisor: 3.5, answer: 24 },
                    { dividend: 162, divisor: 8.1, answer: 20 },
                    { dividend: 100, divisor: 2.5, answer: 40 },
                    { dividend: 75, divisor: 1.5, answer: 50 },
                    { dividend: 168, divisor: 4.2, answer: 40 },
                    { dividend: 144, divisor: 3.6, answer: 40 },
                    { dividend: 210, divisor: 8.4, answer: 25 },
                    { dividend: 96, divisor: 3.2, answer: 30 },
                    { dividend: 105, divisor: 2.1, answer: 50 },
                    { dividend: 126, divisor: 6.3, answer: 20 },
                    { dividend: 180, divisor: 7.2, answer: 25 },
                    { dividend: 150, divisor: 6.0, answer: 25 },
                    { dividend: 63, divisor: 2.1, answer: 30 },
                    { dividend: 117, divisor: 3.9, answer: 30 },
                    { dividend: 88, divisor: 8.8, answer: 10 },
                    { dividend: 54, divisor: 2.7, answer: 20 },
                    { dividend: 132, divisor: 6.6, answer: 20 },
                    { dividend: 91, divisor: 7.0, answer: 13 },
                    { dividend: 189, divisor: 6.3, answer: 30 },
                    { dividend: 216, divisor: 5.4, answer: 40 },
                    { dividend: 252, divisor: 4.2, answer: 60 },
                    { dividend: 315, divisor: 6.3, answer: 50 },
                    { dividend: 108, divisor: 3.6, answer: 30 },
                    { dividend: 195, divisor: 6.5, answer: 30 },
                    { dividend: 234, divisor: 7.8, answer: 30 },
                    { dividend: 171, divisor: 5.7, answer: 30 },
                    { dividend: 288, divisor: 9.6, answer: 30 },
                    { dividend: 324, divisor: 8.1, answer: 40 },
                    { dividend: 378, divisor: 9.45, answer: 40 },
                    { dividend: 420, divisor: 8.4, answer: 50 },
                    { dividend: 468, divisor: 9.36, answer: 50 },
                    { dividend: 512, divisor: 6.4, answer: 80 },
                    { dividend: 567, divisor: 9.45, answer: 60 },
                    { dividend: 42, divisor: 1.4, answer: 30 },
                    { dividend: 56, divisor: 1.6, answer: 35 },
                    { dividend: 69, divisor: 2.3, answer: 30 },
                    { dividend: 92, divisor: 2.3, answer: 40 },
                    { dividend: 115, divisor: 2.3, answer: 50 },
                    { dividend: 138, divisor: 2.3, answer: 60 },
                    { dividend: 161, divisor: 2.3, answer: 70 },
                    { dividend: 184, divisor: 2.3, answer: 80 },
                    { dividend: 207, divisor: 2.3, answer: 90 },
                    { dividend: 48, divisor: 1.2, answer: 40 },
                    { dividend: 64, divisor: 1.6, answer: 40 },
                    { dividend: 80, divisor: 2.0, answer: 40 },
                    { dividend: 112, divisor: 2.8, answer: 40 },
                    { dividend: 128, divisor: 3.2, answer: 40 },
                    { dividend: 176, divisor: 4.4, answer: 40 },
                    { dividend: 192, divisor: 4.8, answer: 40 },
                    { dividend: 208, divisor: 5.2, answer: 40 },
                    { dividend: 224, divisor: 5.6, answer: 40 },
                    { dividend: 240, divisor: 6.0, answer: 40 },
                    { dividend: 36, divisor: 1.2, answer: 30 },
                    { dividend: 60, divisor: 2.0, answer: 30 },
                    { dividend: 90, divisor: 3.0, answer: 30 },
                    { dividend: 150, divisor: 5.0, answer: 30 },
                    { dividend: 270, divisor: 9.0, answer: 30 },
                    { dividend: 45, divisor: 1.5, answer: 30 },
                    { dividend: 85, divisor: 1.7, answer: 50 },
                    { dividend: 102, divisor: 1.7, answer: 60 },
                    { dividend: 119, divisor: 1.7, answer: 70 },
                    { dividend: 136, divisor: 1.7, answer: 80 },
                    { dividend: 153, divisor: 1.7, answer: 90 },
                    { dividend: 39, divisor: 1.3, answer: 30 },
                    { dividend: 52, divisor: 1.3, answer: 40 },
                    { dividend: 65, divisor: 1.3, answer: 50 },
                    { dividend: 78, divisor: 1.3, answer: 60 },
                    { dividend: 91, divisor: 1.3, answer: 70 },
                    { dividend: 104, divisor: 1.3, answer: 80 },
                    { dividend: 117, divisor: 1.3, answer: 90 },
                    { dividend: 33, divisor: 1.1, answer: 30 },
                    { dividend: 44, divisor: 1.1, answer: 40 },
                    { dividend: 55, divisor: 1.1, answer: 50 },
                    { dividend: 66, divisor: 1.1, answer: 60 },
                    { dividend: 77, divisor: 1.1, answer: 70 },
                    { dividend: 99, divisor: 1.1, answer: 90 },
                    { dividend: 28, divisor: 1.4, answer: 20 },
                    { dividend: 35, divisor: 1.4, answer: 25 },
                    { dividend: 49, divisor: 1.4, answer: 35 },
                    { dividend: 70, divisor: 1.4, answer: 50 },
                    { dividend: 98, divisor: 1.4, answer: 70 },
                    { dividend: 32, divisor: 1.6, answer: 20 },
                    { dividend: 40, divisor: 1.6, answer: 25 },
                    { dividend: 80, divisor: 1.6, answer: 50 },
                    { dividend: 96, divisor: 1.6, answer: 60 },
                    { dividend: 128, divisor: 1.6, answer: 80 },
                    { dividend: 38, divisor: 1.9, answer: 20 },
                    { dividend: 57, divisor: 1.9, answer: 30 },
                    { dividend: 76, divisor: 1.9, answer: 40 },
                    { dividend: 95, divisor: 1.9, answer: 50 },
                    { dividend: 114, divisor: 1.9, answer: 60 },
                    { dividend: 133, divisor: 1.9, answer: 70 },
                    { dividend: 152, divisor: 1.9, answer: 80 },
                    { dividend: 171, divisor: 1.9, answer: 90 },
                    { dividend: 51, divisor: 1.7, answer: 30 },
                    { dividend: 68, divisor: 1.7, answer: 40 },
                    { dividend: 170, divisor: 1.7, answer: 100 }
                ];

                const problem = exactProblems[Math.floor(Math.random() * exactProblems.length)];
                correctAnswer = problem.answer;
                questionEl.innerHTML = `${problem.dividend} ÷ ${problem.divisor} = ?`;
            }

            submitBtn.addEventListener('click', () => {
                if (activeCellIndex === null || (isSinglePlayer && currentPlayer !== 1)) return;

                const userAnswer = parseFloat(answerInput.value.trim());

                if (isNaN(userAnswer)) {
                    resultMessageEl.innerText = "유효한 숫자를 입력해주세요.";
                    resultMessageEl.style.color = '#c0392b';
                    return;
                }

                const isCorrect = Math.abs(userAnswer - correctAnswer) < 0.01;

                if (isCorrect) {
                    clearInterval(timerInterval);

                    const previousOwner = boardState[activeCellIndex];
                    if (previousOwner !== 0) {
                        scores[previousOwner]--;
                    }

                    resultMessageEl.innerText = "정답입니다! 🎉";
                    resultMessageEl.style.color = '#27ae60';

                    const cell = gameBoard.children[activeCellIndex];
                    const currentPlayerColor = players[currentPlayer - 1].color;

                    cell.style.backgroundColor = currentPlayerColor;
                    cell.style.borderColor = currentPlayerColor;

                    boardState[activeCellIndex] = currentPlayer;

                    scores[currentPlayer]++;
                    updateScores();

                    activeCellIndex = null;
                    questionArea.classList.add('initial-hidden');
                    checkGameEnd();
                    isFirstTry = true;
                    switchTurn();

                    setTimeout(() => {
                        if (!isSinglePlayer || currentPlayer === 1) {
                            showAvailableTiles();
                        }
                    }, 100);
                } else {
                    if (isFirstTry) {
                        resultMessageEl.innerText = "아쉽지만 오답이에요. 한 번 더 기회를 드릴게요. 😢";
                        resultMessageEl.style.color = '#c0392b';
                        isFirstTry = false;
                        answerInput.value = '';
                        answerInput.focus();
                    } else {
                        clearInterval(timerInterval);
                        resultMessageEl.innerText = `아쉽지만 오답이에요. 정답은 ${correctAnswer}입니다. 😢 다음 턴으로 넘어갑니다.`;
                        resultMessageEl.style.color = '#c0392b';
                        isFirstTry = true;
                        activeCellIndex = null;
                        questionArea.classList.add('initial-hidden');
                        switchTurn();

                        setTimeout(() => {
                            if (!isSinglePlayer || currentPlayer === 1) {
                                showAvailableTiles();
                            }
                        }, 100);
                    }
                }
            });

            answerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitBtn.click();
                }
            });

            function switchTurn() {
                if (isSinglePlayer) {
                    currentPlayer = currentPlayer === 1 ? 2 : 1;
                } else {
                    currentPlayer = (currentPlayer % totalPlayers) + 1;
                }
                updatePlayerTurn();

                if (isSinglePlayer && currentPlayer === 2) {
                    isComputerThinking = true;
                    setTimeout(computerTurn, 1500);
                } else if (isSinglePlayer && currentPlayer === 1) {
                    isComputerThinking = false;
                    resultMessageEl.innerText = '';
                    resultMessageEl.style.color = '#2c3e50';
                }
            }

            function computerTurn() {
                resultMessageEl.innerText = "컴퓨터가 생각하고 있어요...";
                resultMessageEl.style.color = '#3498db';
                submitBtn.disabled = true;

                let targetCellIndex = -1;
                const computerPlayer = 2;
                const occupiedCells = [];
                for (let i = 0; i < boardState.length; i++) {
                    if (boardState[i] === computerPlayer) {
                        occupiedCells.push(i);
                    }
                }

                if (occupiedCells.length > 0) {
                    const adjacentCandidates = [];
                    occupiedCells.forEach(cellIndex => {
                        const row = Math.floor(cellIndex / 5);
                        const col = cellIndex % 5;
                        const neighbors = [];
                        if (row > 0) neighbors.push(cellIndex - 5);
                        if (row < 4) neighbors.push(cellIndex + 5);
                        if (col > 0) neighbors.push(cellIndex - 1);
                        if (col < 4) neighbors.push(cellIndex + 1);

                        neighbors.forEach(neighborIndex => {
                            if (boardState[neighborIndex] !== computerPlayer) {
                                adjacentCandidates.push(neighborIndex);
                            }
                        });
                    });

                    if (adjacentCandidates.length > 0) {
                        targetCellIndex = adjacentCandidates[Math.floor(Math.random() * adjacentCandidates.length)];
                    } else {
                        const emptyCells = boardState.reduce((acc, state, index) => {
                            if (state === 0) acc.push(index);
                            return acc;
                        }, []);
                        if (emptyCells.length > 0) {
                            targetCellIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                        }
                    }
                } else {
                    targetCellIndex = boardState.indexOf(0);
                }

                if (targetCellIndex === -1) {
                    checkGameEnd();
                    isComputerThinking = false;
                    switchTurn();
                    submitBtn.disabled = false;
                    return;
                }

                activeCellIndex = targetCellIndex;
                generateMixedQuestion();
                const computerQuestion = questionEl.innerHTML;
                questionEl.innerHTML = `컴퓨터의 턴: ${computerQuestion}`;

                let isCorrect = Math.random() > 0.1;

                setTimeout(() => {
                    if (isCorrect) {
                        resultMessageEl.innerText = "컴퓨터가 정답을 맞혔어요! 🤖";
                        resultMessageEl.style.color = '#27ae60';

                        const previousOwner = boardState[activeCellIndex];
                        if (previousOwner !== 0) {
                            scores[previousOwner]--;
                        }

                        const cell = gameBoard.children[activeCellIndex];
                        const currentPlayerColor = players[currentPlayer - 1].color;

                        cell.style.backgroundColor = currentPlayerColor;
                        cell.style.borderColor = currentPlayerColor;

                        boardState[activeCellIndex] = currentPlayer;

                        scores[currentPlayer]++;
                        updateScores();

                        activeCellIndex = null;
                        checkGameEnd();
                        isComputerThinking = false;
                        switchTurn();
                    } else {
                        resultMessageEl.innerText = "컴퓨터가 오답을 냈어요. 😅";
                        resultMessageEl.style.color = '#c0392b';
                        activeCellIndex = null;
                        isComputerThinking = false;
                        switchTurn();
                    }
                    submitBtn.disabled = false;
                }, 1000);
            }

            function checkGameEnd() {
                const remainingCells = boardState.filter(cell => cell === 0).length;
                if (remainingCells === 0) {
                    submitBtn.disabled = true;
                    restartBtn.classList.remove('hidden');
                    let winner = 0;
                    let maxScore = -1;

                    for (let i = 1; i <= players.length; i++) {
                        if (scores[i] > maxScore) {
                            maxScore = scores[i];
                            winner = i;
                        } else if (scores[i] === maxScore && winner > 0) {
                            winner = -1;
                        }
                    }

                    if (isSinglePlayer) {
                        if (scores[1] > scores[2]) {
                            resultMessageEl.innerText = `게임 종료! 당신이 승리했습니다! 🏆`;
                        } else if (scores[2] > scores[1]) {
                            resultMessageEl.innerText = `게임 종료! 컴퓨터가 승리했습니다! 🤖`;
                        } else {
                            resultMessageEl.innerText = `게임 종료! 무승부입니다! 🤝`;
                        }
                    } else if (winner > 0) {
                        resultMessageEl.innerText = `게임 종료! ${players[winner - 1].name}가 승리했습니다! 🏆`;
                    } else {
                        resultMessageEl.innerText = `게임 종료! 무승부입니다! 🤝`;
                    }
                    questionEl.innerHTML = '';
                    questionArea.classList.add('initial-hidden');
                }
            }

            backToStartBtn.addEventListener('click', () => {
                location.reload();
            });

            restartBtn.addEventListener('click', () => {
                location.reload();
            });

        });
    </script>
</body>

</html>